# ============================================================================
# OREPA - Old Royalists Engineering Professionals Association
# Docker Compose Configuration
# ============================================================================
#
# Purpose:
#   This file orchestrates three main services for the OREPA application:
#   1. Frontend - Next.js 14 application with App Router
#   2. Backend - Express.js API server with Node.js
#   3. PostgreSQL - Relational database for data persistence
#
# Architecture:
#   - All services run in isolated containers
#   - Custom bridge network for secure inter-service communication
#   - Named volumes for PostgreSQL data persistence
#   - Environment-based configuration for flexibility
#   - Health checks ensure service reliability
#
# Usage:
#   Development: docker-compose up
#   Rebuild:     docker-compose up --build
#   Background:  docker-compose up -d
#   Stop:        docker-compose down
#   Full reset:  docker-compose down -v (WARNING: deletes Database data)
#
# ============================================================================

# ============================================================================
# SERVICES DEFINITION
# ============================================================================

services:

  # ==========================================================================
  # FRONTEND SERVICE - Next.js Application
  # ==========================================================================
  #
  # Runs the Next.js 14 frontend with App Router
  # Features:
  #   - Hot Module Replacement (HMR) for instant updates during development
  #   - Port 3000 exposed to host machine
  #   - Volume mounts for live code updates
  #   - Automatic restart on failure
  #
  frontend:
    # Build configuration
    build:
      context: ./frontend                    # Build context is the frontend directory
      dockerfile: Dockerfile                 # Uses frontend/Dockerfile
      target: base                           # Target the development stage

    container_name: orepa-frontend          # Friendly container name for easier management

    # Port mapping: host:container
    # Access the frontend at http://localhost:3000
    ports:
      - "3000:3000"

    # Volume mounts for hot reload and development
    volumes:
      - ./frontend:/app                      # Mount source code for live updates
      - /app/node_modules                    # Anonymous volume to preserve node_modules
      - /app/.next                           # Anonymous volume to preserve Next.js build cache

    # Environment variables
    environment:
      - NODE_ENV=development                 # Enable development mode features
      - NEXT_PUBLIC_API_URL=http://localhost:5001/api  # Backend API endpoint
      - WATCHPACK_POLLING=true               # Enable polling for file changes (needed in some environments)

    # Dependency management
    # Frontend depends on backend being healthy before starting
    depends_on:
      backend:
        condition: service_healthy

    # Network configuration
    networks:
      - orepa-network

    # Restart policy
    # Restart automatically unless explicitly stopped
    restart: unless-stopped

    # Health check to ensure the service is running properly
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s                          # Check every 30 seconds
      timeout: 10s                           # Timeout after 10 seconds
      retries: 3                             # Retry 3 times before marking as unhealthy
      start_period: 40s                      # Give the service 40 seconds to start

  # ==========================================================================
  # BACKEND SERVICE - Express.js API Server
  # ==========================================================================
  #
  # Runs the Express.js backend API
  # Features:
  #   - RESTful API endpoints
  #   - JWT authentication
  #   - MongoDB integration with Mongoose
  #   - Auto-restart on code changes with nodemon
  #   - Comprehensive error handling and logging
  #
  backend:
    # Build configuration
    build:
      context: ./backend                     # Build context is the backend directory
      dockerfile: Dockerfile                 # Uses backend/Dockerfile
      target: base                           # Target the development stage

    container_name: orepa-backend           # Friendly container name

    # Port mapping: host:container
    # Access the backend API at http://localhost:5001
    ports:
      - "5001:5000"

    # Volume mounts for hot reload
    volumes:
      - ./backend:/app                       # Mount source code for live updates
      - /app/node_modules                    # Preserve node_modules in container

    # Environment variables
    environment:
      - NODE_ENV=development                 # Enable development mode
      - PORT=5000                            # Server port
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public
      - JWT_SECRET=${JWT_SECRET}             # JWT signing key
      - JWT_EXPIRE=${JWT_EXPIRE}             # JWT expiration time
      - CORS_ORIGIN=${CORS_ORIGIN}           # Allowed CORS origin (frontend URL)

    # Dependency management
    # Backend waits for PostgreSQL to be healthy before starting
    depends_on:
      postgres:
        condition: service_healthy

    # Network configuration
    networks:
      - orepa-network

    # Restart policy
    restart: unless-stopped

    # Health check to ensure the API is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # POSTGRESQL SERVICE - Relational Database
  # ==========================================================================
  #
  # PostgreSQL database for persistent data storage
  # Features:
  #   - ACID Compliance
  #   - Relational data model with Prisma ORM
  #   - Data persistence with named volumes
  #
  postgres:
    # Official PostgreSQL image from Docker Hub
    image: postgres:15-alpine                # Use PostgreSQL 15 Alpine version

    container_name: orepa-db          # Friendly container name

    # Port mapping: host:container
    # Access PostgreSQL at localhost:5434
    ports:
      - "5434:5432"

    # Volume for data persistence
    volumes:
      - postgres_data:/var/lib/postgresql/data # Named volume for PostgreSQL data

    # Environment variables
    environment:
      - POSTGRES_USER=${POSTGRES_USER}       # Default user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD} # Default password
      - POSTGRES_DB=${POSTGRES_DB}           # Default database

    # Network configuration
    networks:
      - orepa-network

    # Restart policy
    restart: unless-stopped

    # Health check to ensure PostgreSQL is ready
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

# ============================================================================
# NETWORKS
# ============================================================================
#
# Custom bridge network for inter-service communication
# Benefits:
#   - Services can communicate using service names as hostnames
#   - Isolated from other Docker networks
#   - Better security and network management
#
networks:
  orepa-network:
    driver: bridge                           # Bridge driver for same-host communication
    name: orepa-network                      # Explicit network name

# ============================================================================
# VOLUMES
# ============================================================================
#
# Named volumes for persistent data storage
# Data in these volumes persists across container restarts
# Use 'docker-compose down -v' to delete volumes (WARNING: data loss)
#
volumes:
  # PostgreSQL data volume
  # Stores all database tables and records
  postgres_data:
    driver: local
    name: orepa-postgres-data

# ============================================================================
# END OF DOCKER COMPOSE CONFIGURATION
# ============================================================================
