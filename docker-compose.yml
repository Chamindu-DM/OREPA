# ============================================================================
# OREPA - Old Royalists Engineering Professionals Association
# Docker Compose Configuration
# ============================================================================
#
# Purpose:
#   This file orchestrates two main services for the OREPA application:
#   1. Frontend - Next.js 16 application with App Router
#   2. Backend  - Express.js API server with Node.js
#
# Database:
#   PostgreSQL is hosted on Supabase (external service).
#   The DATABASE_URL and DIRECT_URL environment variables must be set
#   in a .env file at the project root or passed via the environment.
#
# Architecture:
#   - Frontend and Backend run in isolated containers
#   - Custom bridge network for secure inter-service communication
#   - Database is external (Supabase) — no local PostgreSQL container
#   - Environment-based configuration for flexibility
#   - Health checks ensure service reliability
#
# Usage:
#   Development: docker-compose up
#   Rebuild:     docker-compose up --build
#   Background:  docker-compose up -d
#   Stop:        docker-compose down
#
# Required .env Variables:
#   DATABASE_URL    - Supabase PostgreSQL connection string (pooled)
#   DIRECT_URL      - Supabase PostgreSQL direct connection string
#   JWT_SECRET      - Secret key for JWT token signing
#   JWT_EXPIRE      - JWT expiration time (e.g., '7d')
#   CORS_ORIGIN     - Allowed CORS origin (e.g., http://localhost:3000)
#
# ============================================================================

# ============================================================================
# SERVICES DEFINITION
# ============================================================================

services:

  # ==========================================================================
  # FRONTEND SERVICE - Next.js Application
  # ==========================================================================
  #
  # Runs the Next.js 16 frontend with App Router
  # Features:
  #   - Hot Module Replacement (HMR) for instant updates during development
  #   - Port 3000 exposed to host machine
  #   - Volume mounts for live code updates
  #   - Automatic restart on failure
  #
  frontend:
    # Build configuration
    build:
      context: ./frontend                    # Build context is the frontend directory
      dockerfile: Dockerfile                 # Uses frontend/Dockerfile
      target: base                           # Target the development stage

    container_name: orepa-frontend          # Friendly container name for easier management

    # Port mapping: host:container
    # Access the frontend at http://localhost:3000
    ports:
      - "3000:3000"

    # Volume mounts for hot reload and development
    volumes:
      - ./frontend:/app                      # Mount source code for live updates
      - /app/node_modules                    # Anonymous volume to preserve node_modules
      - /app/.next                           # Anonymous volume to preserve Next.js build cache

    # Environment variables
    environment:
      - NODE_ENV=development                 # Enable development mode features
      - NEXT_PUBLIC_API_URL=http://localhost:5001/api  # Backend API endpoint
      - WATCHPACK_POLLING=true               # Enable polling for file changes (needed in some environments)

    # Dependency management
    # Frontend depends on backend being healthy before starting
    depends_on:
      backend:
        condition: service_healthy

    # Network configuration
    networks:
      - orepa-network

    # Restart policy
    # Restart automatically unless explicitly stopped
    restart: unless-stopped

    # Health check to ensure the service is running properly
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s                          # Check every 30 seconds
      timeout: 10s                           # Timeout after 10 seconds
      retries: 3                             # Retry 3 times before marking as unhealthy
      start_period: 40s                      # Give the service 40 seconds to start

  # ==========================================================================
  # BACKEND SERVICE - Express.js API Server
  # ==========================================================================
  #
  # Runs the Express.js backend API
  # Features:
  #   - RESTful API endpoints
  #   - JWT authentication
  #   - Supabase PostgreSQL integration with Prisma ORM
  #   - Auto-restart on code changes with nodemon
  #   - Comprehensive error handling and logging
  #
  # Database:
  #   Connects to Supabase (external hosted PostgreSQL).
  #   No local database container is needed.
  #
  backend:
    # Build configuration
    build:
      context: ./backend                     # Build context is the backend directory
      dockerfile: Dockerfile                 # Uses backend/Dockerfile
      target: base                           # Target the development stage

    container_name: orepa-backend           # Friendly container name

    # Port mapping: host:container
    # Access the backend API at http://localhost:5001
    ports:
      - "5001:5000"

    # Volume mounts for hot reload
    volumes:
      - ./backend:/app                       # Mount source code for live updates
      - /app/node_modules                    # Preserve node_modules in container

    # Environment variables
    # DATABASE_URL and DIRECT_URL connect to Supabase (external PostgreSQL)
    environment:
      - NODE_ENV=development                 # Enable development mode
      - PORT=5000                            # Server port
      - DATABASE_URL=${DATABASE_URL}         # Supabase pooled connection string
      - DIRECT_URL=${DIRECT_URL}             # Supabase direct connection string
      - JWT_SECRET=${JWT_SECRET}             # JWT signing key
      - JWT_EXPIRE=${JWT_EXPIRE}             # JWT expiration time
      - CORS_ORIGIN=${CORS_ORIGIN}           # Allowed CORS origin (frontend URL)

    # No depends_on for database — Supabase is external and always available

    # Network configuration
    networks:
      - orepa-network

    # Restart policy
    restart: unless-stopped

    # Health check to ensure the API is responding
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ============================================================================
# NETWORKS
# ============================================================================
#
# Custom bridge network for inter-service communication
# Benefits:
#   - Services can communicate using service names as hostnames
#   - Isolated from other Docker networks
#   - Better security and network management
#
networks:
  orepa-network:
    driver: bridge                           # Bridge driver for same-host communication
    name: orepa-network                      # Explicit network name

# ============================================================================
# END OF DOCKER COMPOSE CONFIGURATION
# ============================================================================
