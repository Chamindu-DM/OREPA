// ============================================================================
// OREPA Backend - Admin Action Log Model (Mongoose Schema)
// ============================================================================
//
// Purpose:
//   Defines the AdminActionLog schema for auditing all admin activities
//   Tracks who did what, when, and provides accountability
//
// Features:
//   - Comprehensive admin action tracking
//   - Before/after state capture for data changes
//   - IP address and user agent logging for security
//   - Reference to admin who performed action
//   - Timestamped for chronological tracking
//   - Supports different resource types
//
// Dependencies:
//   - mongoose: MongoDB object modeling
//
// Usage:
//   const AdminActionLog = require('./models/AdminActionLog');
//   await AdminActionLog.create({ admin: userId, action: 'CREATE_USER', ... });
//
// ============================================================================

const mongoose = require('mongoose');

// ============================================================================
// ADMIN ACTION LOG SCHEMA DEFINITION
// ============================================================================

/**
 * Admin Action Log Schema
 *
 * Tracks all administrative actions for audit and accountability
 * Provides complete audit trail of admin activities
 */
const adminActionLogSchema = new mongoose.Schema(
  {
    // ========================================================================
    // ADMIN INFORMATION
    // ========================================================================

    /**
     * Admin User Reference
     * - Reference to the admin who performed this action
     * - Required for all log entries
     * - Used to track accountability
     */
    admin: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
      required: [true, 'Admin reference is required'],
      index: true, // Create index for efficient querying by admin
    },

    /**
     * Admin Email
     * - Email of the admin at the time of action
     * - Stored separately in case admin is deleted
     * - Ensures audit trail remains intact
     */
    adminEmail: {
      type: String,
      required: true,
    },

    /**
     * Admin Role
     * - Role of the admin at the time of action
     * - Helps understand permission context
     * - Stored for historical accuracy even if role changes
     */
    adminRole: {
      type: String,
      required: true,
      enum: ['MEMBER_ADMIN', 'CONTENT_ADMIN', 'NEWSLETTER_ADMIN', 'SUPER_ADMIN'],
    },

    // ========================================================================
    // ACTION INFORMATION
    // ========================================================================

    /**
     * Action Type
     * - Describes what action was performed
     * - Predefined enum of all possible admin actions
     * - Used for filtering and reporting
     */
    action: {
      type: String,
      required: [true, 'Action type is required'],
      enum: {
        values: [
          // Authentication Actions
          'LOGIN',
          'LOGOUT',
          'PASSWORD_RESET',
          'PASSWORD_CHANGE',

          // User Management Actions
          'CREATE_USER',
          'UPDATE_USER',
          'DELETE_USER',
          'APPROVE_USER',
          'REJECT_USER',
          'SUSPEND_USER',
          'REACTIVATE_USER',
          'RESET_USER_PASSWORD',

          // Admin Management Actions
          'CREATE_ADMIN',
          'DELETE_ADMIN',
          'CHANGE_ROLE',

          // Newsletter Actions
          'CREATE_NEWSLETTER',
          'UPDATE_NEWSLETTER',
          'DELETE_NEWSLETTER',
          'PUBLISH_NEWSLETTER',
          'SCHEDULE_NEWSLETTER',
          'CANCEL_NEWSLETTER',

          // Project Actions
          'CREATE_PROJECT',
          'UPDATE_PROJECT',
          'DELETE_PROJECT',
          'PUBLISH_PROJECT',

          // LMS Actions
          'CREATE_LMS_CONTENT',
          'UPDATE_LMS_CONTENT',
          'DELETE_LMS_CONTENT',

          // Scholarship Actions
          'CREATE_SCHOLARSHIP',
          'UPDATE_SCHOLARSHIP',
          'DELETE_SCHOLARSHIP',

          // Media Actions
          'UPLOAD_MEDIA',
          'UPLOAD_FILE',           // Keep for backward compatibility
          'DELETE_MEDIA',
          'DELETE_FILE',           // Keep for backward compatibility
          'EDIT_MEDIA',

          // Page Actions
          'EDIT_PAGE',
          'PUBLISH_PAGE',
          'UPDATE_CONTENT',

          // System Configuration Actions
          'CHANGE_SETTINGS',
          'SYSTEM_SETTINGS_CHANGE',
          'CONFIG_UPDATE',
          'BACKUP_INITIATED',
          'MAINTENANCE_MODE_TOGGLE',
          'EMERGENCY_LOCKDOWN',
        ],
        message: '{VALUE} is not a valid action type',
      },
      index: true, // Create index for filtering by action type
    },

    // ========================================================================
    // RESOURCE INFORMATION
    // ========================================================================

    /**
     * Resource Type
     * - Type of resource affected by this action
     * - Examples: 'User', 'Newsletter', 'Project', 'LMS', 'Scholarship'
     * - Optional: not all actions affect a specific resource
     */
    resourceType: {
      type: String,
      default: null,
    },

    /**
     * Resource ID
     * - MongoDB ObjectId of the affected resource
     * - Used to link action to specific document
     * - Optional: not all actions affect a specific resource
     */
    resourceId: {
      type: mongoose.Schema.Types.ObjectId,
      default: null,
      index: true, // Create index for querying by resource
    },

    // ========================================================================
    // ACTION DETAILS
    // ========================================================================

    /**
     * Description
     * - Human-readable description of the action
     * - Provides context and details
     * - Useful for audit reports
     */
    description: {
      type: String,
      default: '',
    },

    /**
     * Before State
     * - Snapshot of data before the action
     * - Stored as flexible Mixed type
     * - Enables rollback and comparison
     * - Optional: only for update/delete actions
     */
    beforeState: {
      type: mongoose.Schema.Types.Mixed,
      default: null,
    },

    /**
     * After State
     * - Snapshot of data after the action
     * - Stored as flexible Mixed type
     * - Enables viewing changes made
     * - Optional: only for create/update actions
     */
    afterState: {
      type: mongoose.Schema.Types.Mixed,
      default: null,
    },

    // ========================================================================
    // SECURITY INFORMATION
    // ========================================================================

    /**
     * IP Address
     * - IP address from which action was performed
     * - Used for security auditing
     * - Helps detect suspicious activity
     */
    ipAddress: {
      type: String,
      default: null,
    },

    /**
     * User Agent
     * - Browser/client information
     * - Helps identify device and browser used
     * - Useful for security investigations
     */
    userAgent: {
      type: String,
      default: null,
    },

    // ========================================================================
    // TIMESTAMP
    // ========================================================================

    /**
     * Timestamp
     * - When the action occurred
     * - Automatically set to current time
     * - Used for chronological ordering
     */
    timestamp: {
      type: Date,
      default: Date.now,
      required: true,
      index: true, // Create index for time-based queries
    },
  },
  {
    // ========================================================================
    // SCHEMA OPTIONS
    // ========================================================================

    // Disable automatic timestamps since we have custom timestamp field
    timestamps: false,

    // Customize toJSON transformation
    toJSON: {
      virtuals: true,
      transform: function (doc, ret) {
        // Remove MongoDB internal fields
        delete ret.__v;
        return ret;
      },
    },

    // Customize toObject transformation
    toObject: {
      virtuals: true,
    },
  }
);

// ============================================================================
// INDEXES
// ============================================================================

// Compound index for admin and timestamp
// Optimizes queries for "get all actions by specific admin"
adminActionLogSchema.index({ admin: 1, timestamp: -1 });

// Compound index for action type and timestamp
// Optimizes queries for "get all actions of specific type"
adminActionLogSchema.index({ action: 1, timestamp: -1 });

// Compound index for resource queries
// Optimizes queries for "get all actions on specific resource"
adminActionLogSchema.index({ resourceType: 1, resourceId: 1, timestamp: -1 });

// Text index for description search
// Enables full-text search in action descriptions
adminActionLogSchema.index({ description: 'text' });

// ============================================================================
// STATIC METHODS
// ============================================================================

/**
 * Get Recent Actions Static Method
 *
 * Retrieves most recent admin actions with pagination
 * Includes admin user information via population
 *
 * @param {number} limit - Number of actions to retrieve (default: 20)
 * @param {number} skip - Number of actions to skip (default: 0)
 * @returns {Promise<AdminActionLog[]>} Array of action log documents
 *
 * @example
 *   const recentActions = await AdminActionLog.getRecentActions(10);
 */
adminActionLogSchema.statics.getRecentActions = async function (limit = 20, skip = 0) {
  return await this.find()
    .populate('admin', 'firstName lastName email role')
    .sort({ timestamp: -1 })
    .limit(limit)
    .skip(skip)
    .lean();
};

/**
 * Get Actions By Admin Static Method
 *
 * Retrieves all actions performed by a specific admin
 * Sorted by timestamp (most recent first)
 *
 * @param {string} adminId - MongoDB ObjectId of admin user
 * @param {number} limit - Number of actions to retrieve (default: 50)
 * @returns {Promise<AdminActionLog[]>} Array of action log documents
 *
 * @example
 *   const adminActions = await AdminActionLog.getActionsByAdmin(adminId);
 */
adminActionLogSchema.statics.getActionsByAdmin = async function (adminId, limit = 50) {
  return await this.find({ admin: adminId })
    .sort({ timestamp: -1 })
    .limit(limit)
    .lean();
};

/**
 * Get Actions By Resource Static Method
 *
 * Retrieves all actions performed on a specific resource
 * Useful for viewing complete history of a document
 *
 * @param {string} resourceType - Type of resource (e.g., 'User', 'Newsletter')
 * @param {string} resourceId - MongoDB ObjectId of resource
 * @returns {Promise<AdminActionLog[]>} Array of action log documents
 *
 * @example
 *   const userHistory = await AdminActionLog.getActionsByResource('User', userId);
 */
adminActionLogSchema.statics.getActionsByResource = async function (resourceType, resourceId) {
  return await this.find({ resourceType, resourceId })
    .populate('admin', 'firstName lastName email role')
    .sort({ timestamp: -1 })
    .lean();
};

/**
 * Get Actions By Type Static Method
 *
 * Retrieves all actions of a specific type
 * Useful for security audits and reporting
 *
 * @param {string} actionType - Type of action (e.g., 'DELETE_USER', 'CREATE_ADMIN')
 * @param {Date} startDate - Start date for filtering (optional)
 * @param {Date} endDate - End date for filtering (optional)
 * @returns {Promise<AdminActionLog[]>} Array of action log documents
 *
 * @example
 *   const deletions = await AdminActionLog.getActionsByType('DELETE_USER');
 */
adminActionLogSchema.statics.getActionsByType = async function (actionType, startDate, endDate) {
  const query = { action: actionType };

  // Add date range if provided
  if (startDate || endDate) {
    query.timestamp = {};
    if (startDate) query.timestamp.$gte = startDate;
    if (endDate) query.timestamp.$lte = endDate;
  }

  return await this.find(query)
    .populate('admin', 'firstName lastName email role')
    .sort({ timestamp: -1 })
    .lean();
};

/**
 * Get Action Statistics Static Method
 *
 * Aggregates action statistics for reporting
 * Groups actions by type and counts occurrences
 *
 * @param {Date} startDate - Start date for statistics (optional)
 * @param {Date} endDate - End date for statistics (optional)
 * @returns {Promise<Object[]>} Array of { _id: actionType, count: number }
 *
 * @example
 *   const stats = await AdminActionLog.getActionStatistics();
 *   // Returns: [{ _id: 'CREATE_USER', count: 45 }, { _id: 'APPROVE_USER', count: 32 }, ...]
 */
adminActionLogSchema.statics.getActionStatistics = async function (startDate, endDate) {
  const matchStage = {};

  // Add date range if provided
  if (startDate || endDate) {
    matchStage.timestamp = {};
    if (startDate) matchStage.timestamp.$gte = startDate;
    if (endDate) matchStage.timestamp.$lte = endDate;
  }

  const pipeline = [];

  // Add match stage if date filtering is needed
  if (Object.keys(matchStage).length > 0) {
    pipeline.push({ $match: matchStage });
  }

  // Group by action type and count
  pipeline.push({
    $group: {
      _id: '$action',
      count: { $sum: 1 },
    },
  });

  // Sort by count (descending)
  pipeline.push({
    $sort: { count: -1 },
  });

  return await this.aggregate(pipeline);
};

// ============================================================================
// CREATE AND EXPORT MODEL
// ============================================================================

/**
 * AdminActionLog Model
 *
 * Compiled Mongoose model from adminActionLogSchema
 * Provides interface for CRUD operations on admin_action_logs collection
 */
const AdminActionLog = mongoose.model('AdminActionLog', adminActionLogSchema);

module.exports = AdminActionLog;

// ============================================================================
// END OF ADMIN ACTION LOG MODEL
// ============================================================================
